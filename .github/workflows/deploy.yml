name: ğŸš€ Continuous Integration
on:
  push:
    branches:
      - main
      - dev
  pull_request: {}

permissions:
  actions: write
  contents: read

jobs:
  dependencies:
    name: ğŸ§¶ Download dependencies
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.9.1
        with:
          access_token: ${{ github.token }}

      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸš˜ Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: ğŸ§¶ Download deps
        uses: bahmutov/npm-install@v1

      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v2
        id: restore-deps
        with:
          path: ./*
          key: ${{ github.sha }}

  # lint:
  #   name: â¬£ ESLint
  #   runs-on: ubuntu-latest
  #   needs: [dependencies]
  #   steps:
  #     - name: ğŸ›‘ Cancel Previous Runs
  #       uses: styfle/cancel-workflow-action@0.9.1
  #       with:
  #         access_token: ${{ github.token }}
  #
  #     - name: â¬‡ï¸ Checkout repo
  #       uses: actions/checkout@v3
  #
  #     - name: â” Setup node
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 16
  #
  #     - name: ğŸ“¦ Restore dependencies
  #       uses: actions/cache@v2
  #       id: restore-deps
  #       with:
  #         path: ./*
  #         key: ${{ github.sha }}
  #
  #     - name: ğŸ”¬ Lint
  #       run: npm run lint
  #
  # typecheck:
  #   name: Ê¦ TypeScript
  #   runs-on: ubuntu-latest
  #   needs: [dependencies]
  #   steps:
  #     - name: ğŸ›‘ Cancel Previous Runs
  #       uses: styfle/cancel-workflow-action@0.9.1
  #       with:
  #         access_token: ${{ github.token }}
  #
  #     - name: â¬‡ï¸ Checkout repo
  #       uses: actions/checkout@v3
  #
  #     - name: â” Setup node
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 16
  #
  #     - name: ğŸ“¦ Restore dependencies
  #       uses: actions/cache@v2
  #       id: restore-deps
  #       with:
  #         path: ./*
  #         key: ${{ github.sha }}
  #
  #     - name: ğŸ” Type check
  #       run: npm run typecheck --if-present
  #
  # vitest:
  #   name: âš¡ Vitest
  #   runs-on: ubuntu-latest
  #   needs: [dependencies]
  #   steps:
  #     - name: ğŸ›‘ Cancel Previous Runs
  #       uses: styfle/cancel-workflow-action@0.9.1
  #       with:
  #         access_token: ${{ github.token }}
  #
  #     - name: â¬‡ï¸ Checkout repo
  #       uses: actions/checkout@v3
  #
  #     - name: â” Setup node
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 16
  #
  #     - name: ğŸ“¦ Restore dependencies
  #       uses: actions/cache@v2
  #       id: restore-deps
  #       with:
  #         path: ./*
  #         key: ${{ github.sha }}
  #
  #     - name: âš¡ Run vitest
  #       run: npm run test -- --coverage
  #
  # cypress:
  #   name: âš«ï¸ Cypress
  #   runs-on: ubuntu-latest
  #   needs: [dependencies]
  #   steps:
  #     - name: ğŸ›‘ Cancel Previous Runs
  #       uses: styfle/cancel-workflow-action@0.9.1
  #       with:
  #         access_token: ${{ github.token }}
  #
  #     - name: â¬‡ï¸ Checkout repo
  #       uses: actions/checkout@v3
  #
  #     - name: ğŸ’» Start up MySQL
  #       run: docker compose up -d
  #
  #     - name: ğŸ„ Copy test env vars
  #       run: cp .env.example .env
  #
  #     - name: â” Setup node
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 16
  #
  #     - name: ğŸ“¦ Restore dependencies
  #       uses: actions/cache@v2
  #       id: restore-deps
  #       with:
  #         path: ./*
  #         key: ${{ github.sha }}
  #
  #     - name: ğŸ›  Push Prisma
  #       run: npx prisma db push
  #
  #     - name: âš™ï¸ Build
  #       run: npm run build
  #
  #     - name: ğŸŒ³ Cypress run
  #       uses: cypress-io/github-action@v4
  #       with:
  #         start: npm run start:mocks
  #         wait-on: "http://localhost:3000"

  preview:
    name: ğŸ”® Deploy Preview
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' }}
    # needs: [lint, typecheck, vitest, cypress]
    needs: [dependencies]
    steps:
      - name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.9.1
        with:
          access_token: ${{ github.token }}

      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3

      - name: â” Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: ğŸ“¦ Restore dependencies
        uses: actions/cache@v2
        id: restore-deps
        with:
          path: ./*
          key: ${{ github.sha }}

      - name: ğŸŒ Branch database (PlanetScale)
        timeout-minutes: 3
        env:
          BRANCH_NAME: ${{ github.event.inputs.branch }}
          DB_NAME: ${{secrets.PLANETSCALE_DB_NAME}}
          ORG_NAME: ${{secrets.PLANETSCALE_ORG_NAME}}
          SERVICE_TOKEN: ${{secrets.PLANETSCALE_SERVICE_TOKEN}}
          SERVICE_TOKEN_ID: ${{secrets.PLANETSCALE_SERVICE_TOKEN_ID}}
        working-directory: .pscale
        run: |
          echo $BRANCH_NAME
          ./create_pr_branch.sh

      - name: ğŸ”’ Set env variable (Netlify)
        run : netlify env:import ./.pscale/.env 

      - name: ğŸ’¿ Deploy preview (Netlify)
        run: netlify deploy --build --context deploy-preview
